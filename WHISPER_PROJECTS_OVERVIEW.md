# Whisper Projects Overview

این سند خلاصه‌ای از دو پروژه نود برای پردازش زیرنویس با ویسپر ارائه می‌دهد.

## ساختار کلی

دو پروژه جداگانه ایجاد شده است:

### 1. `whisper-task-runner`
**هدف**: ماشین تخصصی زیرنویس‌گذاری با کنترل بازه زمانی و مدیریت صف تسک‌ها

**ویژگی‌های کلیدی**:
- ✅ کنترل بازه زمانی استفاده از GPU (مثلاً ۱۱ شب تا ۵ صبح)
- ✅ مدیریت صف فایل‌ها از پوشه ورودی یا دیتابیس MySQL
- ✅ سیستم لاک فایل برای جلوگیری از پردازش تکراری
- ✅ وب‌سرویس REST API کامل برای مدیریت تسک‌ها
- ✅ پنل ادمین (Adminer) برای مدیریت دیتابیس
- ✅ MySQL پرسیست با volume داکر
- ✅ پشتیبانی از bulk import تسک‌ها

**پورت‌ها**:
- API: `3000`
- Adminer: `8080`
- MySQL: `3306`

### 2. `whisper-cron-worker`
**هدف**: پردازش خودکار فایل‌ها بر اساس زمان‌بندی کران و ارسال گزارش

**ویژگی‌های کلیدی**:
- ✅ زمان‌بندی کران قابل تنظیم (پیش‌فرض: هر ساعت)
- ✅ ارسال گزارش به تلگرام یا وب‌هوک
- ✅ کنترل فعال/غیرفعال بودن کران از طریق API یا اسکریپت شل
- ✅ اجرای دستی job از طریق API
- ✅ گزارش‌های تفصیلی از پردازش‌ها

**پورت‌ها**:
- API: `3001`

## معماری

```
┌─────────────────────────────────────┐
│   whisper-task-runner               │
│                                     │
│  ┌──────────┐    ┌──────────────┐  │
│  │ Worker   │───▶│ MySQL        │  │
│  │ (GPU)    │    │ (Persistent) │  │
│  └──────────┘    └──────────────┘  │
│       │                              │
│       ▼                              │
│  ┌──────────┐    ┌──────────────┐  │
│  │ Express  │    │ Adminer     │  │
│  │ API      │    │ (DB Admin)  │  │
│  └──────────┘    └──────────────┘  │
│                                     │
│  Time Window: 23:00 - 05:00        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│   whisper-cron-worker               │
│                                     │
│  ┌──────────┐    ┌──────────────┐  │
│  │ Cron     │───▶│ Whisper      │  │
│  │ Job      │    │ (GPU)        │  │
│  └──────────┘    └──────────────┘  │
│       │                              │
│       ▼                              │
│  ┌──────────┐    ┌──────────────┐  │
│  │ Express  │    │ Notifier    │  │
│  │ API      │───▶│ (Telegram/  │  │
│  └──────────┘    │  Webhook)    │  │
│                   └──────────────┘  │
│                                     │
│  Schedule: 0 * * * * (hourly)      │
└─────────────────────────────────────┘
```

## جریان کار

### پروژه اول (Task Runner)

1. **اسکن پوشه ورودی**: Worker به صورت مداوم پوشه `INPUT_DIR` را اسکن می‌کند
2. **بررسی فایل‌ها**: فایل‌هایی که قبلاً SRT دارند یا لاک دارند، رد می‌شوند
3. **بررسی بازه زمانی**: اگر خارج از بازه فعال باشد، worker منتظر می‌ماند
4. **پردازش**: در بازه فعال، فایل‌ها با ویسپر پردازش می‌شوند
5. **مدیریت دیتابیس**: اگر پوشه خالی باشد، تسک‌ها از MySQL برداشته می‌شوند
6. **Timeout**: تسک‌های قدیمی‌تر از ۲ ساعت می‌توانند دوباره اختصاص داده شوند

### پروژه دوم (Cron Worker)

1. **زمان‌بندی**: کران‌جاب بر اساس `CRON_SCHEDULE` اجرا می‌شود
2. **اسکن فایل‌ها**: فایل‌های ویدئویی بدون SRT پیدا می‌شوند
3. **پردازش**: هر فایل با ویسپر پردازش می‌شود
4. **گزارش**: گزارش تفصیلی تولید و به تلگرام/وب‌هوک ارسال می‌شود

## متغیرهای محیطی مهم

### whisper-task-runner
```env
ACTIVE_START_HOUR=23      # ساعت شروع استفاده از GPU
ACTIVE_END_HOUR=5         # ساعت پایان
INPUT_DIR=/media/input    # پوشه ورودی
OUTPUT_DIR=/media/output  # پوشه خروجی
BATCH_SIZE=2             # تعداد فایل‌های پردازش شده در هر batch
MYSQL_HOST=mysql         # هاست MySQL
```

### whisper-cron-worker
```env
CRON_ENABLED=true         # فعال بودن کران
CRON_SCHEDULE=0 * * * *   # زمان‌بندی کران
TELEGRAM_BOT_TOKEN=...    # توکن ربات تلگرام
TELEGRAM_CHAT_ID=...      # شناسه چت تلگرام
REPORT_WEBHOOK_URL=...    # URL وب‌هوک برای گزارش
```

## نحوه استفاده

### راه‌اندازی پروژه اول

```bash
cd whisper-task-runner
cp .env.example .env
# ویرایش .env
docker compose up -d
```

### راه‌اندازی پروژه دوم

```bash
cd whisper-cron-worker
cp .env.example .env
# ویرایش .env و تنظیم تلگرام یا وب‌هوک
docker compose up -d
```

### اضافه کردن تسک از طریق API

```bash
# پروژه اول
curl -X POST http://localhost:3000/api/tasks \
  -H "Content-Type: application/json" \
  -d '{"inputPath": "/media/input/video.mp4"}'

# Bulk import
curl -X POST http://localhost:3000/api/tasks/bulk \
  -H "Content-Type: application/json" \
  -d '{"tasks": [{"inputPath": "/path/to/file1.mp4"}, {"inputPath": "/path/to/file2.mp4"}]}'
```

### کنترل کران در پروژه دوم

```bash
# فعال/غیرفعال کردن
curl -X POST http://localhost:3001/api/cron/enable
curl -X POST http://localhost:3001/api/cron/disable

# اجرای دستی
curl -X POST http://localhost:3001/api/job/run
```

## یکپارچه‌سازی با n8n

هر دو پروژه می‌توانند با n8n یکپارچه شوند:

### پروژه اول
- **ایجاد تسک**: استفاده از HTTP Request node برای `POST /api/tasks`
- **بررسی وضعیت**: استفاده از `GET /api/tasks` برای مانیتورینگ
- **Bulk Import**: استفاده از `POST /api/tasks/bulk` برای واردات انبوه

### پروژه دوم
- **کنترل کران**: استفاده از `POST /api/cron/enable` یا `/disable`
- **اجرای دستی**: استفاده از `POST /api/job/run`
- **دریافت گزارش**: تنظیم `REPORT_WEBHOOK_URL` به یک webhook در n8n

## نکات مهم

1. **GPU**: هر دو پروژه نیاز به GPU دارند. مطمئن شوید NVIDIA Container Toolkit نصب است.
2. **حافظه**: مدل `large` ویسپر نیاز به حداقل ۸ گیگابایت حافظه GPU دارد.
3. **پرسیست**: MySQL در پروژه اول با volume داکر پرسیست می‌شود.
4. **زمان‌بندی**: پروژه اول فقط در بازه زمانی مشخص از GPU استفاده می‌کند.
5. **لاک فایل‌ها**: سیستم لاک فایل از پردازش تکراری جلوگیری می‌کند.

## مستندات بیشتر

- `whisper-task-runner/README.md` - مستندات کامل پروژه اول
- `whisper-task-runner/QUICKSTART.md` - راهنمای سریع پروژه اول
- `whisper-cron-worker/README.md` - مستندات کامل پروژه دوم
- `whisper-cron-worker/QUICKSTART.md` - راهنمای سریع پروژه دوم

