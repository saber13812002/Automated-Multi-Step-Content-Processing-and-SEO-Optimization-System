# ุฑุงูููุง ุฑุงูโุงูุฏุงุฒ ู ุงุณุชูุงุฏู

ุงู ูพุฑูฺู ุงุณฺฉุฑูพุช ุจุฑุง ุฎูุงูุฏู ุฏุงุฏูโูุง `book_pages.sql` ู ุจุงุฑฺฏุฐุงุฑ ูพุงุฑุงฺฏุฑุงูโูุง ุชูุฒโุดุฏู ุฏุฑ ChromaDB ูุฑุงูู ูโฺฉูุฏ. ููฺูู ุงุณฺฉุฑูพุช ูุณุชูู ุจุฑุง ุชุณุช ู ูุดุงูุฏู ูุชุงุฌ ุฌุณุชุฌู ูุนูุง ุฏุฑ ูุฌููุนูโ ุงุฌุงุฏ ุดุฏู ูุฌูุฏ ุฏุงุฑุฏ.

> ๐ ุจุฑุง ูุดุงูุฏู ููุฑุณุช ฺฉุงูู ูฺฺฏโูุง ู ูุงุจูุชโูุง ูพุงุฏูโุณุงุฒ ุดุฏูุ ุจู [FEATURES.md](FEATURES.md) ูุฑุงุฌุนู ฺฉูุฏ.

## ูพุดโูุงุฒูุง

- Python 3.10 ุง ุฌุฏุฏุชุฑ
- ุฏุณุชุฑุณ ุจู ุณุฑูุณ ChromaDB (ููฺฉุงู ุง ุงุฒ ุทุฑู ุดุจฺฉู)
- ฺฉูุฏ API ุจุฑุง OpenAI (ุฏุฑ ุตูุฑุช ุงุณุชูุงุฏู ุงุฒ ุจุฑุฏุงุฑูุง OpenAI)

## ูุตุจ ูุงุจุณุชฺฏโูุง

```bash
python -m venv .venv
.venv\Scripts\activate             # ุฏุฑ ููุฏูุฒ
# ุง
sudo apt update
sudo apt install python3.12-venv
python3 -m venv .venv
source .venv/bin/activate          # ุฏุฑ ูููฺฉุณ/ูฺฉ

pip install -r requirements.txt
```

## ูพฺฉุฑุจูุฏ ูุชุบุฑูุง ูุญุท

ูโุชูุงูุฏ ูุชุบุฑูุง ุฑุง ุจู ุตูุฑุช ุฏุณุช ุง ุจุง ุงุณุชูุงุฏู ุงุฒ ูุงู `.env` ุชูุธู ฺฉูุฏ. ูููโุชุฑู ฺฏุฒููโูุง:

- `BOOK_PAGES_SQL`: ูุณุฑ ูุงู SQL (ูพุดโูุฑุถ `book_pages.sql`)
- `CHROMA_HOST`, `CHROMA_PORT`, `CHROMA_SSL`, `CHROMA_API_KEY`: ุชูุธูุงุช ุงุชุตุงู ุจู ุณุฑูุฑ ChromaDB
- `CHROMA_COLLECTION`: ูุงู ฺฉุงูฺฉุดู ููุตุฏ (ูพุดโูุฑุถ `book_pages`)
- `OPENAI_API_KEY`: ฺฉูุฏ OpenAI ุจุฑุง ุชููุฏ ุงูุจุฏูฺฏ
- `CHUNK_MAX_LENGTH`: ุทูู ูุฑ ูุทุนู ูุชู (ูพุดโูุฑุถ ฒฐฐ ฺฉุงุฑุงฺฉุชุฑ)
- `CHUNK_CONTEXT_LENGTH`: ุทูู ูุชู ุฒููู ูุจู ู ุจุนุฏ ุงุฒ ูุฑ ูุทุนู (ูพุดโูุฑุถ ฑฐฐ ฺฉุงุฑุงฺฉุชุฑ)
- `CHROMA_BATCH_SIZE`: ุงูุฏุงุฒู ุฏุณุชู ุจุฑุง ุจุงุฑฺฏุฐุงุฑ (ูพุดโูุฑุถ ดธ)

## ุงุฌุฑุง ุงุณฺฉุฑูพุช ุตุงุฏุฑุงุช

```bash
python export-sql-backup-to-chromadb.py \
  --sql-path book_pages.sql \
  --collection book_pages \
  --host 10.0.0.5 \
  --port 8000 \
  --embedding-provider openai \
  --reset
```


```bash
python3 export-sql-backup-to-chromadb.py   --sql-path book_pages_mini.sql   --collection book_pages_mini   --host 192.168.1.68   --port 8000  --embedding-provider openai   --reset
```


- ฺฏุฒูู `--reset` ฺฉุงูฺฉุดู ูุจู ุฑุง ุญุฐู ู ุฏุงุฏูโูุง ุฌุฏุฏ ุฑุง ุฌุงฺฏุฒู ูโฺฉูุฏ.
- ุงฺฏุฑ ุงุฒ ChromaDB ุชูฺฉุงุฑ (Persist Client) ุงุณุชูุงุฏู ูโฺฉูุฏุ ฺฏุฒูู `--persist-directory ./chroma-store` ุฑุง ุงุถุงูู ฺฉูุฏ.
- ุฏุฑ ุตูุฑุช ูุจูุฏ ฺฉูุฏ OpenAI ูโุชูุงูุฏ `--embedding-provider none` ุฑุง ุงูุชุฎุงุจ ฺฉูุฏุ ุฏุฑ ุงู ุญุงูุช ูุฑุถ ูโุดูุฏ ุณูุช ุณุฑูุฑ ุงูุจุฏูฺฏ ุชููุฏ ูโุดูุฏ.

### ููุทู ูุทุนูโุจูุฏ

1. ูุฑ ุฑฺฉูุฑุฏ ุตูุญู ุงุฒ SQL ุฎูุงูุฏู ู HTML ุขู ุจู ูุชู ุณุงุฏู ุชุจุฏู ูโุดูุฏ.
2. ูุชู ุจุฑ ุงุณุงุณ ูพุงุฑุงฺฏุฑุงู (ูุงุตููโ ุฏู ุฎุท) ุฌุฏุง ูโุดูุฏ.
3. ูุฑ ูพุงุฑุงฺฏุฑุงู ุจู ูุทุนุงุช ุญุฏุงฺฉุซุฑ ฒฐฐ ฺฉุงุฑุงฺฉุชุฑ ุชูุณู ูโุดูุฏ.
4. ุจุฑุง ูุฑ ูุทุนู ฑฐฐ ฺฉุงุฑุงฺฉุชุฑ ูุจู ู ุจุนุฏ ุจูโุนููุงู ุฒููู ุงุถุงูู ูโุดูุฏ ุชุง ููููู ุญูุธ ุดูุฏ.
5. ูุฑ ูุทุนู ุจู ููุฑุงู ูุชุงุฏุชุง (ฺฉุชุงุจุ ุจุฎุดุ ููฺฉุ ุดูุงุฑู ูพุงุฑุงฺฏุฑุงู ู Segment) ุฏุฑ ChromaDB ุฐุฎุฑู ูโุดูุฏ.

## ุชุณุช ู ุงุฑุฒุงุจ ูุชุงุฌ

ูพุณ ุงุฒ ูพุงุงู ุจุงุฑฺฏุฐุงุฑ ูโุชูุงูุฏ ุงุฒ ุงุณฺฉุฑูพุช ุฒุฑ ุจุฑุง ุงุฑุณุงู ฺฉูุฆุฑ ู ุจุฑุฑุณ ูุชุงุฌ ุงุณุชูุงุฏู ฺฉูุฏ:

```bash
python verify_chroma_export.py \
  --collection book_pages \
  --query "ุฏู ฺุณุช" \
  --host 10.0.0.5 \
  --port 8000 \
  --top-k 5
```

ุฎุฑูุฌ ุดุงูู ุดูุงุณูุ ูุงุตููุ ููฺฉ ููุจุน ู ูพุดโููุงุด ูุฑ ูุทุนู ุงุณุช ุชุง ุจุชูุงูุฏ ฺฉูุช ุฏุงุฏูโูุง ุฐุฎุฑูโุดุฏู ุฑุง ุงุฑุฒุงุจ ฺฉูุฏ.

## ูฺฉุงุช ุชฺฉูู

- ุฏุฑ ูุชุงุฏุชุงุ ููฺฉ ุงุตู ุตูุญู (`source_link`) ุฐุฎุฑู ูโุดูุฏ ุชุง ุงุฑุฌุงุน ุจู ููุจุน ุญูุธ ฺฏุฑุฏุฏ.
- ููุฏ `error` ุงุฒ ูุงู SQL ูุฒ ููุชูู ูโุดูุฏ ุชุง ุฏุฑ ุตูุฑุช ูุฌูุฏ ุฎุทุง ุง ูุดุฏุงุฑ ุฏุฑ ููุจุน ุจุชูุงูุฏ ุขู ุฑุง ุฑุฏุงุจ ฺฉูุฏ.
- ุฏุฑ ุตูุฑุช ูุงุฒ ุจู ูุทุนูโุจูุฏ ูุชูุงูุชุ ูพุงุฑุงูุชุฑูุง `--max-length` ู `--context` ุฑุง ุชุบุฑ ุฏูุฏ.
- **ุงูุจุฏูฺฏโูุง ฺฺฏููู ุณุงุฎุชู ูโุดููุฏุ**
  - ูพุงุฑุงูุชุฑ `--embedding-provider` ุชุนู ูโฺฉูุฏ ฺฉู ุขุง ุจุฑุฏุงุฑูุง ููฺฏุงู ูุงุฑุฏ ฺฉุฑุฏู ุฏุงุฏู ุณุงุฎุชู ุดููุฏ ุง ุฎุฑ.
  - ููุฏุงุฑ ูพุดโูุฑุถ `openai` ุจุง ูุฏู `text-embedding-3-small` ุจุฑุง ูุฑ ุณฺฏููุช ฺฉ ุจุฑุฏุงุฑ ฑตณถ ุจุนุฏ ุชููุฏ ูโฺฉูุฏ ู ุขู ุฑุง ุจู ฺฉุงูฺฉุดู ุงุถุงูู ูโููุงุฏุ ุงู ุญุงูุช ุจุฑุง ููุช ููุงุณุจ ุงุณุช ฺฉู ูโุฎูุงูุฏ ูููโฺุฒ ุณูุช ุงุณฺฉุฑูพุช ุงูุฌุงู ุดูุฏ.
  - ุงฺฏุฑ ฺฏุฒููโ `--embedding-provider none` ุฑุง ุงูุชุฎุงุจ ฺฉูุฏุ ููุท ูุชู ู ูุชุงุฏุชุง ุฐุฎุฑู ูโุดููุฏ ู ุจุงุฏ ุฏุฑ ูุฑุงุญู ุจุนุฏ (ูุซูุงู ุฑู ุณุฑูุฑ Chroma ุง ุณุฑูุณ ุฏฺฏุฑ) ุงูุจุฏูฺฏ ุณุงุฎุชู ุดูุฏ. ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุฌุณุชโูุฌู ุจุฑุฏุงุฑ ูุชุฌูโุง ูุฎูุงูุฏ ุฏุงุดุช.
  - ููฺฏุงู ุฌุณุชโูุฌู (ฺู ุจุง `verify_chroma_export.py` ู ฺู ุจุง APIโูุง ุฏฺฏุฑ) ููุงู ูุฏู ุจุงุฏ ุจุฑุง ุชููุฏ ุงูุจุฏูฺฏ ุณุคุงู ุงุณุชูุงุฏู ุดูุฏุ ฺูู Chroma ุจุฑุฏุงุฑ ฺฉูุฆุฑ ุฑุง ุจุง ุจุฑุฏุงุฑูุง ุฐุฎุฑูโุดุฏู ููุงุณู ูโฺฉูุฏ.

## ุณุฑูุณ ูุจ ุฌุณุชุฌู ูุนูุง

ฺฉ ุณุฑูุณ FastAPI ุฏุฑ ูุณุฑ `web_service/` ุงุถุงูู ุดุฏู ุชุง ฺฉูุฆุฑ ฺฉุงุฑุจุฑ ุฑุง ฺฏุฑูุชูุ ุจุง ููุงู ูุฏู `text-embedding-3-small` ุงูุจุฏูฺฏ ฺฉูุฏ ู ุฑู ChromaDB ุฌุณุชุฌู ุงูุฌุงู ุฏูุฏ.

### ุงุฌุฑุง ูุญู

```bash
cd export-sql-chromadb
python -m venv .venv
.venv\Scripts\activate  # ุง source .venv/bin/activate
pip install -r web_service/requirements.txt
uvicorn web_service.app:app --reload --host 0.0.0.0 --port 8080
```

ุณุฑูุณ ุงุฒ ููุงู `.env` ุงุณุชูุงุฏู ูโฺฉูุฏ. ูุณุฑูุง:

- `POST /search` ูุฑูุฏ:

```json
{
  "query": "ุขููุฒุด ุนูุงุฏ ฺุณุชุ",
  "top_k": 5
}
```

ุฎุฑูุฌ ุดุงูู `id`, `distance`, `score`, `document`, `metadata` ู ุงุทูุงุนุงุช ูุฏู ุงุณุช.

- `GET /health` ูุถุนุช ChromaDBุ Redisุ ู ุขูุงุฑ ฺฉุงูฺฉุดู ุฑุง ุจุงุฒูโฺฏุฑุฏุงูุฏ.

### ูุชุบุฑูุง ูุญุท ูุฑุชุจุท ุจุง ุณุฑูุณ ูุจ

- `APP_HOST` ู `APP_PORT` ุจุฑุง ฺฉูุชุฑู ุขุฏุฑุณ ู ูพูุฑุช ุณุฑูุณ (ูพุดโูุฑุถ: `0.0.0.0:8080`)
- `REDIS_URL` ุง ุชุฑฺฉุจ `REDIS_HOST`, `REDIS_PORT`, `REDIS_DB`, `REDIS_PASSWORD`
- ุณุงุฑ ูุชุบุฑูุง ููุงู ููุงุฏุฑ ููุฑุฏ ุงุณุชูุงุฏู ุฏุฑ ุงุณฺฉุฑูพุชโูุง ุตุงุฏุฑุงุช ู ุงุนุชุจุงุฑุณูุฌ (`CHROMA_*`, `OPENAI_API_KEY`, `EMBEDDING_MODEL`, ...)

### Docker

```bash
cd export-sql-chromadb
docker build -t chroma-search-api .
docker run --env-file .env -p 8080:8080 chroma-search-api
```

### Docker Compose

```bash
cd export-sql-chromadb
docker compose up --build
```

ุณุฑูุณ ุจุง ฺฉุงูุชูุฑ Redis ุจุงูุง ูโุขุฏ ู ุชูุงู ูุชุบุฑูุง ูุญุท ุงุฒ ุทุฑู `.env` ุง ูุชุบุฑูุง ูุญุท ุณุณุชู ุชุฒุฑูโูพุฐุฑ ูุณุชูุฏ. Healthcheck ุฏุงุฎู ูุถุนุช `/health` ุฑุง ูพุงุด ูโฺฉูุฏ.
ุฏุฑ ูุงู `docker-compose.yml` ฺฉ ุณุฑูุณ ุงุฎุชุงุฑ `chromadb` ูุฒ ุชุนุฑู ุดุฏู ุชุง ุฏุฑ ูุญุทโูุง ุชูุณุนู ุง ุชุณุช ุจุชูุงูุฏ ChromaDB ุฑุง ุจูโุตูุฑุช ฺฉุงูุชูุฑ ุงุฌุฑุง ฺฉูุฏ. ุฏุฑ ุตูุฑุช ุงุณุชูุงุฏู ุงุฒ ุณุฑูุฑ ุฎุงุฑุฌุ ูโุชูุงูุฏ ุงู ุณุฑูุณ ุฑุง ุญุฐู ุง ุบุฑูุนุงู ฺฉูุฏ.