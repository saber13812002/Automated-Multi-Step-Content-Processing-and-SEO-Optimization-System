<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø¹Ù†Ø§ÛŒÛŒ ChromaDB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .search-box {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-input-group {
            flex: 1;
            min-width: 300px;
        }

        .search-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .top-k-input {
            width: 120px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-button {
            padding: 12px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            align-self: flex-end;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .search-button:active {
            transform: translateY(0);
        }

        .search-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 1.1rem;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .results-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .results-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .results-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .results-meta {
            color: #666;
            font-size: 0.95rem;
        }

        .result-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: box-shadow 0.3s;
        }

        .result-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .result-id {
            font-family: monospace;
            color: #667eea;
            font-size: 0.9rem;
        }

        .result-scores {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .score-badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .distance-badge {
            background: #764ba2;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .result-document {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            line-height: 1.8;
            color: #333;
            border-right: 4px solid #667eea;
        }

        .document-context {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 0.85rem;
            color: #555;
            border-right: 3px solid #667eea;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .document-context strong {
            color: #667eea;
            font-weight: 600;
        }

        .document-content {
            line-height: 1.9;
            color: #2d3748;
            font-size: 1rem;
            text-align: justify;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
            color: #333;
        }

        .search-warning {
            margin-top: 10px;
            padding: 12px 16px;
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            color: #856404;
            font-size: 0.9rem;
            display: none;
        }

        .search-warning.show {
            display: block;
        }

        .search-warning.error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .document-source-link {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .source-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.2s, transform 0.1s;
        }

        .source-link-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .page-level-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 8px;
        }


        .metadata-item {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .metadata-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metadata-label-text {
            flex: 1;
        }

        .metadata-value {
            font-weight: 600;
            color: #333;
        }

        .metadata-info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            position: relative;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .metadata-info-icon:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        .metadata-info-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            right: 0;
            padding: 10px 14px;
            background: #2d3748;
            color: white;
            border-radius: 8px;
            font-size: 0.75rem;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            max-width: 260px;
            min-width: 200px;
            white-space: normal;
            text-align: right;
            line-height: 1.6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .metadata-info-tooltip {
                right: auto;
                left: 0;
                max-width: calc(100vw - 40px);
                min-width: auto;
            }
        }

        .metadata-info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 15px;
            border: 6px solid transparent;
            border-top-color: #2d3748;
        }

        @media (max-width: 768px) {
            .metadata-info-tooltip::after {
                right: auto;
                left: 15px;
            }
        }

        .metadata-info-icon:hover .metadata-info-tooltip {
            opacity: 1;
        }

        .metadata-link {
            color: #667eea;
            text-decoration: none;
        }

        .metadata-link:hover {
            text-decoration: underline;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .history-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            #historyContainer {
                grid-template-columns: 1fr !important;
            }
        }

        .history-section h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .history-button {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .history-button:hover {
            background: #218838;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            margin-left: 6px;
            position: relative;
            vertical-align: middle;
            flex-shrink: 0;
        }

        .info-icon:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .info-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            right: 50%;
            transform: translateX(50%);
            margin-bottom: 5px;
            padding: 10px 14px;
            background: #2d3748;
            color: white;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            max-width: 280px;
            white-space: normal;
            text-align: right;
            line-height: 1.6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 50%;
            transform: translateX(50%);
            border: 6px solid transparent;
            border-top-color: #2d3748;
        }

        .info-icon:hover .info-tooltip {
            opacity: 1;
        }

        .config-info {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .approved-queries-box {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .approved-queries-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .approved-queries-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .approved-query-chip {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .approved-query-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .model-selector {
            margin-top: 20px;
            background: #f7f9ff;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 15px;
        }

        .model-selector h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .model-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .model-chip {
            border-radius: 999px;
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .model-chip.selected {
            border-color: #fff;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .model-chip .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .approved-query-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .config-info-item {
            display: inline-block;
            margin-left: 20px;
        }

        .vote-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .vote-button {
            border: none;
            border-radius: 999px;
            padding: 6px 14px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .vote-button.like {
            background: #10B981;
        }

        .vote-button.dislike {
            background: #EF4444;
        }

        .vote-section {
            margin-top: 25px;
            padding: 15px;
            border: 1px dashed rgba(0,0,0,0.1);
            border-radius: 12px;
            background: #fafafa;
        }

        .config-info-label {
            opacity: 0.8;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø¹Ù†Ø§ÛŒÛŒ ChromaDB</h1>
            <p>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø± Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø§Ø³Ù†Ø§Ø¯</p>
            <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;" id="versionTop">Ù†Ø³Ø®Ù‡: <span id="versionNumber">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span></div>
            <div class="config-info" id="configInfo" style="display: none;">
                <span class="config-info-item">
                    <span class="config-info-label">Ú©Ø§Ù„Ú©Ø´Ù†:</span>
                    <strong id="collectionName">-</strong>
                </span>
                <span class="config-info-item">
                    <span class="config-info-label">Ù…Ø¯Ù„ Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯:</span>
                    <strong id="embeddingModel">-</strong>
                </span>
            </div>
        </div>

        <!-- Approved Queries Box -->
        <div class="approved-queries-box" id="approvedQueriesBox" style="display: none;">
            <h3>ğŸ”¥ Ø³ÙˆØ§Ø¨Ù‚ Ø¬Ø³ØªØ¬ÙˆÛŒ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</h3>
            <div class="approved-queries-list" id="approvedQueriesList"></div>
        </div>

        <div class="search-box">
            <form class="search-form" id="searchForm">
                <div class="search-input-group">
                    <label for="query">Ù…ØªÙ† Ø¬Ø³ØªØ¬Ùˆ:</label>
                    <input 
                        type="text" 
                        id="query" 
                        class="search-input" 
                        placeholder="Ù…ØªÙ† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."
                        required
                    >
                    <div class="search-warning" id="searchWarning">
                        âš ï¸ Ø¨Ø±Ø§ÛŒ Ù†ØªØ§ÛŒØ¬ Ø¨Ù‡ØªØ±ØŒ Ù„Ø·ÙØ§Ù‹ Ø¨ÛŒØ´ Ø§Ø² ÛŒÚ© Ú©Ù„Ù…Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. Ø¬Ø³ØªØ¬ÙˆÛŒ ØªÚ©â€ŒÚ©Ù„Ù…Ù‡â€ŒØ§ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ØªØ§ÛŒØ¬ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ù†Ø¯Ù‡Ø¯.
                    </div>
                </div>
                <div class="search-input-group" style="flex: 0 0 auto;">
                    <label for="topK">ØªØ¹Ø¯Ø§Ø¯ Ù†ØªØ§ÛŒØ¬:</label>
                    <input 
                        type="number" 
                        id="topK" 
                        class="top-k-input" 
                        value="20" 
                        min="1" 
                        max="50"
                        required
                    >
                </div>
                <div class="search-input-group" style="flex: 0 0 auto; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <input 
                        type="checkbox" 
                        id="useCache" 
                        checked
                        style="width: 18px; height: 18px; cursor: pointer;"
                    >
                    <label for="useCache" style="margin: 0; cursor: pointer; font-size: 0.9rem;">
                        Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ø´
                        <span class="info-icon" style="margin-right: 4px;">
                            â„¹
                            <span class="info-tooltip" style="max-width: 250px;">
                                Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù†ØªØ§ÛŒØ¬ Ú©Ø´ Ø´Ø¯Ù‡ Ø¯Ø± Redis (Ø§Ú¯Ø± Ù‡Ù…Ø§Ù† Ú©ÙˆØ¦Ø±ÛŒ Ùˆ Ù…Ø¯Ù„ Ø¯Ø± Ú©Ù…ØªØ± Ø§Ø² 1 Ø³Ø§Ø¹Øª Ø¬Ø³ØªØ¬Ùˆ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
                            </span>
                        </span>
                    </label>
                    <input 
                        type="checkbox" 
                        id="includeFullContext" 
                        style="width: 18px; height: 18px; cursor: pointer; margin-right: 12px;"
                    >
                    <label for="includeFullContext" style="margin: 0; cursor: pointer; font-size: 0.9rem;">
                        Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù
                        <span class="info-icon" style="margin-right: 4px;">
                            â„¹
                            <span class="info-tooltip" style="max-width: 250px;">
                                Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ø¨Ù‡ Ø¬Ø§ÛŒ ÙÙ‚Ø· Ø³Ú¯Ù…Ù†Øª Ù¾ÛŒØ¯Ø§ Ø´Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ú© Ø¨Ù‡ØªØ± Ù…Ø­ØªÙˆØ§)
                            </span>
                        </span>
                    </label>
                </div>
                <button type="submit" class="search-button" id="searchButton">
                    Ø¬Ø³ØªØ¬Ùˆ
                </button>
            </form>
            <div class="model-selector" id="modelSelector" style="display:none;">
                <h4>Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</h4>
                <p style="color:#555; font-size:0.9rem; margin-bottom:10px;">
                    Ø­Ø¯Ø§Ú©Ø«Ø± 3 Ù…Ø¯Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ù†ØªØ§ÛŒØ¬ Ø¨Ù‡ ØµÙˆØ±Øª ÛŒÚ©ÛŒ Ø¯Ø± Ù…ÛŒØ§Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯.
                </p>
                <div class="model-chips" id="modelChips"></div>
            </div>
        </div>

        <div id="errorContainer"></div>
        <div id="loadingContainer"></div>
        <div id="resultsContainer"></div>
        <div id="historySection" class="history-section" style="display: none;">
            <h2>ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¬Ø³ØªØ¬Ùˆ</h2>
            <button class="history-button" onclick="loadHistory()">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
            <div id="historyContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3 style="margin-bottom: 10px; color: #667eea;">Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</h3>
                    <div id="recentHistoryContainer"></div>
                </div>
                <div>
                    <h3 style="margin-bottom: 10px; color: #667eea;">Ù¾Ø±Ø¨Ø³Ø§Ù…Ø¯ØªØ±ÛŒÙ† Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§</h3>
                    <div id="topQueriesContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        
        // Persian translations for metadata fields
        const metadataLabels = {
            'book_title': 'Ø¹Ù†ÙˆØ§Ù† Ú©ØªØ§Ø¨',
            'book_id': 'Ø´Ù†Ø§Ø³Ù‡ Ú©ØªØ§Ø¨',
            'paragraph_index': 'Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù',
            'page_id': 'Ø´Ù…Ø§Ø±Ù‡ ØµÙØ­Ù‡',
            'section_id': 'Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø®Ø´',
            'segment_index': 'Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø·Ø¹Ù‡',
            'source_link': 'Ù„ÛŒÙ†Ú© Ù…Ù†Ø¨Ø¹',
            'section_title': 'Ø¹Ù†ÙˆØ§Ù† Ø¨Ø®Ø´',
            'error': 'Ø®Ø·Ø§',
            'segment_end': 'Ù¾Ø§ÛŒØ§Ù† Ù‚Ø·Ø¹Ù‡',
            'segment_length': 'Ø·ÙˆÙ„ Ù‚Ø·Ø¹Ù‡',
            'segment_start': 'Ø´Ø±ÙˆØ¹ Ù‚Ø·Ø¹Ù‡',
            'has_error': 'Ø¯Ø§Ø±Ø§ÛŒ Ø®Ø·Ø§',
            'record_id': 'Ø´Ù†Ø§Ø³Ù‡ Ø±Ú©ÙˆØ±Ø¯',
            'paragraph_full_text': 'Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù',
            'page_full_text': 'Ù…ØªÙ† Ú©Ø§Ù…Ù„ ØµÙØ­Ù‡',
            'page_full_text_hash': 'Ù‡Ø´ Ù…ØªÙ† Ú©Ø§Ù…Ù„ ØµÙØ­Ù‡'
        };

        // Tooltip descriptions for metadata fields
        const metadataTooltips = {
            'book_title': 'Ø¹Ù†ÙˆØ§Ù† Ú©ØªØ§Ø¨ÛŒ Ú©Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø² Ø¢Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ Ø§Ø³Øª.',
            'book_id': 'Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ÛŒ Ú©ØªØ§Ø¨ Ø¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡.',
            'paragraph_index': 'Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ø¯Ø± ØµÙØ­Ù‡ (Ø´Ø±ÙˆØ¹ Ø§Ø² Û°).',
            'page_id': 'Ø´Ù…Ø§Ø±Ù‡ ØµÙØ­Ù‡ Ø¯Ø± Ú©ØªØ§Ø¨ Ú©Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø² Ø¢Ù† Ø¢Ù…Ø¯Ù‡ Ø§Ø³Øª.',
            'section_id': 'Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ÛŒ Ø¨Ø®Ø´ Ø¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡.',
            'segment_index': 'Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø·Ø¹Ù‡ Ø¯Ø± Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù (Ø´Ø±ÙˆØ¹ Ø§Ø² Û°).',
            'source_link': 'Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¯Ø± ÙˆØ¨â€ŒØ³Ø§ÛŒØª Ù…Ù†Ø¨Ø¹.',
            'section_title': 'Ø¹Ù†ÙˆØ§Ù† Ø¨Ø®Ø´ Ú©Ù‡ Ø§ÛŒÙ† Ù‚Ø·Ø¹Ù‡ Ø¨Ù‡ Ø¢Ù† ØªØ¹Ù„Ù‚ Ø¯Ø§Ø±Ø¯.',
            'error': 'Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯ Ù…Ø´Ú©Ù„ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯.',
            'segment_end': 'Ù…ÙˆÙ‚Ø¹ÛŒØª Ù¾Ø§ÛŒØ§Ù† Ù‚Ø·Ø¹Ù‡ Ø¯Ø± Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù (Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø§Ú©ØªØ±).',
            'segment_length': 'Ø·ÙˆÙ„ Ù‚Ø·Ø¹Ù‡ Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø§Ú©ØªØ±.',
            'segment_start': 'Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ø±ÙˆØ¹ Ù‚Ø·Ø¹Ù‡ Ø¯Ø± Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù (Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø§Ú©ØªØ±).',
            'has_error': 'Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±.',
            'record_id': 'Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ÛŒ Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø§ØµÙ„ÛŒ.',
            'paragraph_full_text': 'Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ú©Ù‡ Ø§ÛŒÙ† Ø³Ú¯Ù…Ù†Øª Ø§Ø² Ø¢Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ Ø§Ø³Øª.',
            'page_full_text': 'Ù…ØªÙ† Ú©Ø§Ù…Ù„ ØµÙØ­Ù‡ Ú©Ù‡ Ø§ÛŒÙ† Ø³Ú¯Ù…Ù†Øª Ø§Ø² Ø¢Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ Ø§Ø³Øª.',
            'page_full_text_hash': 'Ù‡Ø´ SHA256 Ù…ØªÙ† Ú©Ø§Ù…Ù„ ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ ØµÙØ­Ø§Øª Ø¨Ø²Ø±Ú¯ (Ø¨ÛŒØ´ Ø§Ø² 50KB).'
        };
        
        const searchForm = document.getElementById('searchForm');
        const searchButton = document.getElementById('searchButton');
        const errorContainer = document.getElementById('errorContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultsContainer = document.getElementById('resultsContainer');
        const historySection = document.getElementById('historySection');
        const historyContainer = document.getElementById('historyContainer');
        const modelSelector = document.getElementById('modelSelector');
        const modelChipsContainer = document.getElementById('modelChips');
        
        let activeModels = [];
        let selectedModelIds = new Set();
        let guestUser = null;
        let lastSearchContext = {
            query: '',
            isMulti: false,
            models: [],
            fallbackModelId: null,
            results: []
        };
        
        // Pagination state
        let currentPage = 1;
        let currentQuery = '';
        let currentTopK = 20;

        // Function to check query word count and show/hide warning
        function checkQueryWordCount() {
            const queryInput = document.getElementById('query');
            const warningDiv = document.getElementById('searchWarning');
            if (!queryInput || !warningDiv) return;
            
            const query = queryInput.value.trim();
            const words = query.split(/\s+/).filter(word => word.length > 0);
            const wordCount = words.length;
            
            if (wordCount === 1 && query.length > 0) {
                warningDiv.classList.add('show');
                // Keep as warning (orange), not error (red)
            } else if (wordCount === 0) {
                warningDiv.classList.remove('show');
            } else {
                warningDiv.classList.remove('show');
            }
        }

        // Add event listener to query input for real-time warning
        const queryInput = document.getElementById('query');
        if (queryInput) {
            queryInput.addEventListener('input', checkQueryWordCount);
            queryInput.addEventListener('keyup', checkQueryWordCount);
            queryInput.addEventListener('paste', () => {
                setTimeout(checkQueryWordCount, 10);
            });
        }

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const query = document.getElementById('query').value.trim();
            const topK = parseInt(document.getElementById('topK').value);
            const useCache = document.getElementById('useCache').checked;
            const includeFullContext = document.getElementById('includeFullContext').checked;
            
            if (!query) {
                showError('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
                return;
            }

            // Reset to page 1 for new search
            currentPage = 1;
            currentQuery = query;
            currentTopK = topK;
            
            // Update URL with query params
            const url = new URL(window.location);
            url.searchParams.set('q', query);
            url.searchParams.set('page', '1');
            url.searchParams.set('topK', topK.toString());
            window.history.pushState({}, '', url);

            await performSearch(query, topK, 1, useCache, includeFullContext);
        });
        
        // Load query from URL on page load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            const page = parseInt(urlParams.get('page')) || 1;
            const topK = parseInt(urlParams.get('topK')) || parseInt(document.getElementById('topK').value) || 20;
            if (query) {
                document.getElementById('query').value = query;
                document.getElementById('topK').value = topK;
                currentQuery = query;
                currentPage = page;
                currentTopK = topK;
                performSearch(query, currentTopK, page);
            }
            historySection.style.display = 'block';
            loadHistory();
            loadActiveModels();
            loadSettings();
            initGuestUser();
        });

        function initGuestUser() {
            if (guestUser) {
                return;
            }
            try {
                const stored = localStorage.getItem('chroma_guest_user');
                if (stored) {
                    guestUser = JSON.parse(stored);
                }
            } catch (error) {
                console.warn('Failed to read guest user from localStorage', error);
            }
            if (!guestUser) {
                guestUser = {
                    user_id: generateGuestId(),
                    token: generateGuestToken(),
                    created_at: new Date().toISOString()
                };
                try {
                    localStorage.setItem('chroma_guest_user', JSON.stringify(guestUser));
                } catch (error) {
                    console.warn('Failed to persist guest user', error);
                }
            }
        }

        function generateGuestId() {
            if (window.crypto && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'guest-' + Math.random().toString(36).substring(2, 10);
        }

        function generateGuestToken() {
            return Math.random().toString(36).substring(2, 10) + Date.now().toString(36);
        }

        async function loadActiveModels() {
            try {
                const response = await fetch('/models/active?limit=10', {
                    headers: { 'Accept': 'application/json; charset=utf-8' }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                activeModels = data.models || [];
                renderModelChips();
            } catch (error) {
                console.warn('Failed to load active models', error);
            }
        }

        async function loadSettings() {
            try {
                // Load default cache setting from localStorage or use default
                const storedCacheSetting = localStorage.getItem('useCache');
                if (storedCacheSetting !== null) {
                    document.getElementById('useCache').checked = storedCacheSetting === 'true';
                } else {
                    // Default to true (can be changed via env var DEFAULT_USE_CACHE)
                    document.getElementById('useCache').checked = true;
                }
                // Load full context setting
                const storedFullContextSetting = localStorage.getItem('includeFullContext');
                if (storedFullContextSetting !== null) {
                    document.getElementById('includeFullContext').checked = storedFullContextSetting === 'true';
                } else {
                    document.getElementById('includeFullContext').checked = false;
                }
            } catch (error) {
                console.warn('Failed to load settings', error);
            }
        }

        // Save preferences to localStorage
        document.getElementById('useCache')?.addEventListener('change', (e) => {
            localStorage.setItem('useCache', e.target.checked.toString());
        });
        document.getElementById('includeFullContext')?.addEventListener('change', (e) => {
            localStorage.setItem('includeFullContext', e.target.checked.toString());
        });

        function renderModelChips() {
            if (!activeModels || activeModels.length === 0) {
                modelSelector.style.display = 'none';
                return;
            }
            modelSelector.style.display = 'block';
            // Preselect first three if nothing selected yet
            if (selectedModelIds.size === 0) {
                activeModels.slice(0, 3).forEach(model => selectedModelIds.add(model.id));
            }

            let html = '';
            activeModels.forEach(model => {
                const isSelected = selectedModelIds.has(model.id);
                const color = model.color && /^#/.test(model.color) ? model.color : '#3B82F6';
                html += `
                    <div class="model-chip ${isSelected ? 'selected' : ''}" onclick="toggleModelChip(${model.id})" title="${escapeHtml(model.collection)}">
                        <span class="color-dot" style="background:${color};"></span>
                        <span>${escapeHtml(model.embedding_model)}</span>
                    </div>
                `;
            });
            modelChipsContainer.innerHTML = html;
        }

        window.toggleModelChip = function(modelId) {
            const maxSelection = 3;
            if (selectedModelIds.has(modelId)) {
                if (selectedModelIds.size === 1) {
                    alert('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…Ø¯Ù„ Ø¨Ø§ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯.');
                    return;
                }
                selectedModelIds.delete(modelId);
            } else {
                if (selectedModelIds.size >= maxSelection) {
                    alert(`Ø­Ø¯Ø§Ú©Ø«Ø± ${maxSelection} Ù…Ø¯Ù„ Ù‚Ø§Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³Øª.`);
                    return;
                }
                selectedModelIds.add(modelId);
            }
            renderModelChips();
        };

        function getSelectedModelIds() {
            if (selectedModelIds.size === 0 && activeModels.length > 0) {
                activeModels.slice(0, 3).forEach(model => selectedModelIds.add(model.id));
            }
            return Array.from(selectedModelIds);
        }

        async function performSearch(query, topK, page = 1, useCache = true, includeFullContext = false) {
            // Clear previous results
            errorContainer.innerHTML = '';
            resultsContainer.innerHTML = '';
            loadingContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</p></div>';
            searchButton.disabled = true;

            const selectedModelIds = getSelectedModelIds();
            if (!selectedModelIds.length) {
                showError('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…Ø¯Ù„ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.');
                loadingContainer.innerHTML = '';
                searchButton.disabled = false;
                return;
            }
            const selectedModelsData = selectedModelIds.map(id => activeModels.find(m => m.id === id)).filter(Boolean);
            const isMulti = selectedModelIds.length > 1;

            try {
                const endpoint = isMulti ? `${API_BASE_URL}/search/multi` : `${API_BASE_URL}/search`;
                const payload = isMulti
                    ? {
                        query,
                        model_ids: selectedModelIds,
                        top_k: topK,
                        save: true
                    }
                    : {
                        query,
                        top_k: topK,
                        page,
                        page_size: topK,  // Use topK as page_size so user's selection is respected
                        save: true,
                        use_cache: useCache,
                        include_full_context: includeFullContext,
                        model_id: selectedModelIds[0]  // Send model_id when single model is selected
                    };
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ');
                }

                // Ensure UTF-8 encoding when parsing JSON
                const data = await response.json();
                displayResults(data, { isMulti, selectedModels: selectedModelsData });
                lastSearchContext = {
                    query,
                    isMulti,
                    models: selectedModelsData,
                    fallbackModelId: selectedModelsData.length === 1 ? selectedModelsData[0].id : null,
                    results: data.results || []
                };
                
                // Update pagination state
                if (!isMulti && data.pagination) {
                    currentPage = data.pagination.page;
                }
                
                // Update URL with current page
                const url = new URL(window.location);
                url.searchParams.set('q', query);
                url.searchParams.set('page', currentPage.toString());
                url.searchParams.set('topK', currentTopK.toString());
                window.history.pushState({}, '', url);
                
                // Update config info in header
                if (!isMulti && data.collection) {
                    document.getElementById('collectionName').textContent = data.collection;
                }
                if (!isMulti && data.model) {
                    document.getElementById('embeddingModel').textContent = data.model;
                }
                if ((!isMulti && data.collection) || (!isMulti && data.model)) {
                    document.getElementById('configInfo').style.display = 'block';
                }
                
                // Show history section after first search
                historySection.style.display = 'block';
            } catch (error) {
                showError(`Ø®Ø·Ø§: ${error.message}`);
            } finally {
                loadingContainer.innerHTML = '';
                searchButton.disabled = false;
            }
        }
        
        function goToPage(page) {
            // Validate page number
            if (page < 1) {
                console.warn('Page number must be at least 1');
                return;
            }
            // Prevent going to pages that are too large (safety check)
            if (page > 1000) {
                console.warn('Page number is too large');
                return;
            }
            if (currentQuery) {
                const useCache = document.getElementById('useCache').checked;
                const includeFullContext = document.getElementById('includeFullContext').checked;
                performSearch(currentQuery, currentTopK, page, useCache, includeFullContext);
            } else {
                console.warn('No current query available');
            }
        }

        function showError(message) {
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        function displayResults(data, options = {}) {
            const { isMulti = false, selectedModels = [] } = options;
            // Show errors even if no results (but some models succeeded)
            if ((!data.results || data.results.length === 0) && (!data.errors || data.errors.length === 0)) {
                resultsContainer.innerHTML = `
                    <div class="results-container">
                        <div class="no-results">
                            <h3>Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                            <p>Ù„Ø·ÙØ§Ù‹ Ú©ÙˆØ¦Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // If we have errors but no results, show errors only
            if ((!data.results || data.results.length === 0) && data.errors && data.errors.length > 0) {
                let html = `
                    <div class="results-container">
                        <div class="results-header">
                            <h2>Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ</h2>
                        </div>
                        <div style="margin: 20px 0; padding: 15px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 8px;">
                            <h3 style="color: #721c24; margin-bottom: 10px;">âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø§Ù… Ù…Ø¯Ù„â€ŒÙ‡Ø§:</h3>
                            <ul style="margin: 0; padding-right: 20px; color: #721c24;">
                                ${data.errors.map(err => `
                                    <li style="margin-bottom: 5px;">
                                        <strong>${escapeHtml(err.model || err.collection)}</strong>: ${escapeHtml(err.error)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                resultsContainer.innerHTML = html;
                return;
            }

            const cacheLabel = data.cache_source ? ` | Ù…Ù†Ø¨Ø¹: ${data.cache_source === 'cache' ? 'Ú©Ø´ (Redis)' : 'Ø²Ù†Ø¯Ù‡'}` : '';
            let html = `
                <div class="results-container">
                    <div class="results-header">
                        <h2>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ</h2>
                        <div class="results-meta">
                            Ú©ÙˆØ¦Ø±ÛŒ: "<strong>${escapeHtml(data.query)}</strong>" | 
                            ${data.pagination ? 
                                `Ù†Ù…Ø§ÛŒØ´ ${data.returned} Ù†ØªÛŒØ¬Ù‡ Ø§Ø² ØµÙØ­Ù‡ ${data.pagination.page}${data.pagination.total_pages ? ` Ø§Ø² ${data.pagination.total_pages}` : ''}${data.pagination.estimated_total_results ? ` (Ú©Ù„: ${data.pagination.estimated_total_results} Ù†ØªÛŒØ¬Ù‡)` : ''}` :
                                `Ù†Ù…Ø§ÛŒØ´ ${data.returned} ${data.top_k ? `Ø§Ø² ${data.top_k}` : ''} Ù†ØªÛŒØ¬Ù‡`
                            } | 
                            Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§: ${data.took_ms.toFixed(2)} Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡${cacheLabel}
                            ${data.total_documents ? ` | Ú©Ù„ Ù…Ø³ØªÙ†Ø¯Ø§Øª: ${data.total_documents.toLocaleString('fa-IR')}` : ''}
                        </div>
                    </div>
            `;
            
            // Display errors if any (for multi-model search)
            if (data.errors && data.errors.length > 0) {
                html += `
                    <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;">
                        <h3 style="color: #856404; margin-bottom: 10px;">âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§:</h3>
                        <ul style="margin: 0; padding-right: 20px; color: #856404;">
                            ${data.errors.map(err => `
                                <li style="margin-bottom: 5px;">
                                    <strong>${escapeHtml(err.model || err.collection)}</strong>: ${escapeHtml(err.error)}
                                </li>
                            `).join('')}
                        </ul>
                        <p style="margin-top: 10px; margin-bottom: 0; color: #856404; font-size: 0.9rem;">
                            Ù†ØªØ§ÛŒØ¬ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚ Ø¯Ø± Ø²ÛŒØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
                        </p>
                    </div>
                `;
            }
            
            // Helper function to generate pagination HTML
            const generatePaginationHtml = (pag) => {
                if (!pag) return '';
                
                let paginationHtml = '<div class="pagination-controls" style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">';
                
                // Previous button with validation
                const prevPage = Math.max(1, pag.page - 1);
                const prevButtonDisabled = !pag.has_previous_page || pag.page <= 1;
                paginationHtml += `
                    <button 
                        class="pagination-button" 
                        onclick="${prevButtonDisabled ? 'return false;' : `goToPage(${prevPage})`}"
                        ${prevButtonDisabled ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : 'style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;"'}
                    >
                        ØµÙØ­Ù‡ Ù‚Ø¨Ù„ÛŒ
                    </button>
                `;
                
                // Page info with better formatting
                let pageInfo = `ØµÙØ­Ù‡ ${pag.page}`;
                if (pag.total_pages) {
                    pageInfo += ` Ø§Ø² ${pag.total_pages}`;
                }
                if (pag.estimated_total_results) {
                    pageInfo += ` (${pag.estimated_total_results} Ù†ØªÛŒØ¬Ù‡)`;
                }
                paginationHtml += `<span style="font-weight: 600; color: #333;">${pageInfo}</span>`;
                
                // Next button with validation
                const nextPage = pag.page + 1;
                const nextButtonDisabled = !pag.has_next_page;
                paginationHtml += `
                    <button 
                        class="pagination-button" 
                        onclick="${nextButtonDisabled ? 'return false;' : `goToPage(${nextPage})`}"
                        ${nextButtonDisabled ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : 'style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;"'}
                    >
                        ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ÛŒ
                    </button>
                `;
                
                paginationHtml += '</div>';
                return paginationHtml;
            };
            
            // Add pagination controls at the top (after errors, before results)
            if (data.pagination) {
                html += generatePaginationHtml(data.pagination);
            }

            // Function to highlight search terms in text
            const highlightSearchTerms = (text, searchQuery) => {
                if (!text || !searchQuery) return escapeHtml(text);
                
                // Escape the text first
                let escapedText = escapeHtml(text);
                
                // Split search query into words (handling Persian and English)
                const words = searchQuery.trim().split(/\s+/).filter(word => word.length > 0);
                
                if (words.length === 0) return escapedText;
                
                // Create a regex pattern that matches each word (case-insensitive, word boundaries)
                // For Persian text, we don't use word boundaries as they don't work well
                const patterns = words.map(word => {
                    // Escape special regex characters
                    const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    // Use word boundary for English, but not for Persian (which uses different characters)
                    const isPersian = /[\u0600-\u06FF]/.test(word);
                    if (isPersian) {
                        return escapedWord;
                    } else {
                        return `\\b${escapedWord}\\b`;
                    }
                });
                
                // Combine patterns with OR
                const combinedPattern = new RegExp(`(${patterns.join('|')})`, 'gi');
                
                // Replace matches with highlighted version
                return escapedText.replace(combinedPattern, '<span class="highlight">$1</span>');
            };

            const renderDocumentWithContext = (document, metadata, searchQuery = '') => {
                const meta = metadata || {};
                const bookTitle = meta.book_title || '';
                const sectionTitle = meta.section_title || '';
                const pageId = meta.page_id !== undefined ? meta.page_id : '';
                const paragraphIndex = meta.paragraph_index !== undefined ? meta.paragraph_index : '';
                const segmentIndex = meta.segment_index !== undefined ? meta.segment_index : '';
                const segmentLength = meta.segment_length !== undefined ? meta.segment_length : '';
                const sourceLink = meta.source_link || '';
                const pageLevel = meta.page_level === true;
                
                // Use paragraph_full_text from metadata if available, otherwise use document
                let documentText = meta.paragraph_full_text || document || '';
                
                // Build context info
                let contextInfo = [];
                if (bookTitle) {
                    contextInfo.push(`<strong>Ú©ØªØ§Ø¨:</strong> ${escapeHtml(bookTitle)}`);
                }
                if (sectionTitle) {
                    contextInfo.push(`<strong>Ø¨Ø®Ø´:</strong> ${escapeHtml(sectionTitle)}`);
                }
                if (pageId !== '') {
                    contextInfo.push(`<strong>ØµÙØ­Ù‡:</strong> ${escapeHtml(String(pageId))}`);
                }
                if (!pageLevel && paragraphIndex !== '') {
                    contextInfo.push(`<strong>Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù:</strong> ${escapeHtml(String(paragraphIndex))}`);
                }
                if (!pageLevel && segmentIndex !== '') {
                    contextInfo.push(`<strong>Ù‚Ø·Ø¹Ù‡:</strong> ${escapeHtml(String(segmentIndex))}`);
                }
                if (segmentLength) {
                    contextInfo.push(`<strong>Ø·ÙˆÙ„:</strong> ${escapeHtml(String(segmentLength))} Ú©Ø§Ø±Ø§Ú©ØªØ±`);
                }
                
                // Add full source link to context
                if (sourceLink) {
                    let url = String(sourceLink).trim();
                    if ((url.startsWith("'") && url.endsWith("'")) || (url.startsWith('"') && url.endsWith('"'))) {
                        url = url.slice(1, -1);
                    }
                    const isAbsolute = /^https?:\/\//i.test(url);
                    if (isAbsolute) {
                        contextInfo.push(`<strong>Ù„ÛŒÙ†Ú© Ù…Ù†Ø¨Ø¹:</strong> <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: underline;">${escapeHtml(url)}</a>`);
                    } else if (url) {
                        contextInfo.push(`<strong>Ù„ÛŒÙ†Ú© Ù…Ù†Ø¨Ø¹:</strong> ${escapeHtml(url)}`);
                    }
                }
                
                // Build page level badge
                const pageLevelBadge = pageLevel ? `
                    <span class="page-level-badge" title="Ø§ÛŒÙ† ÛŒÚ© Ø³Ù†Ø¯ Ú©Ø§Ù…Ù„ ØµÙØ­Ù‡ Ø§Ø³Øª">ğŸ“„ Ø³Ù†Ø¯ Ú©Ø§Ù…Ù„ ØµÙØ­Ù‡</span>
                ` : '';
                
                if (!documentText) return '';
                
                // Highlight search terms in document text
                const highlightedText = highlightSearchTerms(documentText, searchQuery);
                
                return `
                    <div class="result-document">
                        ${contextInfo.length > 0 ? `
                            <div class="document-context">
                                ${contextInfo.join(' | ')}
                                ${pageLevelBadge}
                            </div>
                        ` : ''}
                        <div class="document-content">
                            ${highlightedText}
                        </div>
                    </div>
                `;
            };

            const renderMetadata = (metadata) => {
                if (!metadata || Object.keys(metadata).length === 0) {
                    return '';
                }
                return `
                    <div class="result-metadata">
                        ${Object.entries(metadata).map(([key, value]) => {
                            const persianLabel = metadataLabels[key] || key;
                            const tooltip = metadataTooltips[key] || '';
                            if (key === 'source_link' && value) {
                                let url = String(value).trim();
                                if ((url.startsWith("'") && url.endsWith("'")) || (url.startsWith('"') && url.endsWith('"'))) {
                                    url = url.slice(1, -1);
                                }
                                const isAbsolute = /^https?:\/\//i.test(url);
                                const hrefAttr = isAbsolute ? url : '#';
                                let displayText = url;
                                try {
                                    const urlObj = new URL(url);
                                    const pathMatch = urlObj.pathname.match(/\/node\/(\d+)/);
                                    const hash = urlObj.hash;
                                    if (pathMatch && pathMatch[1]) {
                                        displayText = pathMatch[1] + hash;
                                    } else {
                                        const pathParts = urlObj.pathname.split('/').filter(p => p);
                                        if (pathParts.length > 0) {
                                            displayText = pathParts[pathParts.length - 1] + hash;
                                        }
                                    }
                                } catch (e) {
                                    const match = url.match(/(?:node\/)?(\d+)(#p\d+)?$/i);
                                    if (match) {
                                        displayText = match[1] + (match[2] || '');
                                    } else {
                                        const parts = url.split('/');
                                        displayText = parts[parts.length - 1] || url;
                                    }
                                }
                                const infoIconHtml = tooltip ? `
                                    <span class="metadata-info-icon">â„¹
                                        <span class="metadata-info-tooltip">${escapeHtml(tooltip)}</span>
                                    </span>
                                ` : '';
                                return `
                                    <div class="metadata-item">
                                        <span class="metadata-label">
                                            <span class="metadata-label-text">${escapeHtml(persianLabel)}:</span>
                                            ${infoIconHtml}
                                        </span>
                                        <span class="metadata-value">
                                            <a href="${hrefAttr}" target="_blank" rel="noopener noreferrer" class="metadata-link" title="${escapeHtml(url)}">${escapeHtml(displayText)}</a>
                                        </span>
                                    </div>
                                `;
                            }
                            if (key === 'has_error' && typeof value === 'boolean') {
                                const boolValue = value ? 'Ø¨Ù„Ù‡' : 'Ø®ÛŒØ±';
                                const infoIconHtml = tooltip ? `
                                    <span class="metadata-info-icon">â„¹
                                        <span class="metadata-info-tooltip">${escapeHtml(tooltip)}</span>
                                    </span>
                                ` : '';
                                return `
                                    <div class="metadata-item">
                                        <span class="metadata-label">
                                            <span class="metadata-label-text">${escapeHtml(persianLabel)}:</span>
                                            ${infoIconHtml}
                                        </span>
                                        <span class="metadata-value">${escapeHtml(boolValue)}</span>
                                    </div>
                                `;
                            }
                            const infoIconHtml = tooltip ? `
                                <span class="metadata-info-icon">â„¹
                                    <span class="metadata-info-tooltip">${escapeHtml(tooltip)}</span>
                                </span>
                            ` : '';
                            return `
                                <div class="metadata-item">
                                    <span class="metadata-label">
                                        <span class="metadata-label-text">${escapeHtml(persianLabel)}:</span>
                                        ${infoIconHtml}
                                    </span>
                                    <span class="metadata-value">${escapeHtml(String(value))}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            };

            const fallbackModelId = (!isMulti && selectedModels.length === 1) ? selectedModels[0].id : null;
            const voteTargets = isMulti
                ? selectedModels
                : (selectedModels.length ? selectedModels : [{ id: null, embedding_model: 'Ù†ØªØ§ÛŒØ¬ Ø¬Ø§Ø±ÛŒ', color: '#667eea' }]);

            if (isMulti && selectedModels.length > 0) {
                html += `
                    <div style="margin: 15px 0; padding: 12px; background:#f5f5ff; border-radius:10px;">
                        <strong>Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</strong>
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                            ${selectedModels.map(model => `
                                <span class="model-chip selected" style="background:${model.color || '#3B82F6'}; color:#fff;">
                                    ${escapeHtml(model.embedding_model)}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            data.results.forEach((result, index) => {
                const color = isMulti ? (result.model_color || '#3B82F6') : '#667eea';
                const modelBadge = isMulti ? `
                    <span class="score-badge" style="background:${color};">${escapeHtml(result.embedding_model || '')}</span>
                ` : '';
                const resultModelId = isMulti ? (result.model_id ?? null) : fallbackModelId;
                html += `
                    <div class="result-item" style="border-right:6px solid ${color};">
                        <div class="result-header">
                            <span class="result-id">#${index + 1} - ${escapeHtml(result.id)}</span>
                            <div class="result-scores">
                                ${modelBadge}
                                ${(result.score !== null && result.score !== undefined) ? `
                                    <span class="score-badge">
                                        <span class="info-icon">â„¹
                                            <span class="info-tooltip">Ø§Ù…ØªÛŒØ§Ø² Ø´Ø¨Ø§Ù‡Øª: Ø¹Ø¯Ø¯ÛŒ Ø¨ÛŒÙ† Û° ØªØ§ Û± Ú©Ù‡ Ù†Ø´Ø§Ù†â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ù…ÛŒØ²Ø§Ù† Ø´Ø¨Ø§Ù‡Øª Ù†ØªÛŒØ¬Ù‡ Ø¨Ù‡ Ú©ÙˆØ¦Ø±ÛŒ Ø´Ù…Ø§Ø³Øª. Ù‡Ø± Ú†Ù‡ Ø¹Ø¯Ø¯ Ø¨Ø§Ù„Ø§ØªØ± Ø¨Ø§Ø´Ø¯ØŒ Ù†ØªÛŒØ¬Ù‡ Ù…Ø±ØªØ¨Ø·â€ŒØªØ± Ø§Ø³Øª.</span>
                                        </span>
                                        Ø´Ø¨Ø§Ù‡Øª: ${Number(result.score).toFixed(4)}
                                    </span>
                                ` : ''}
                                ${(result.distance !== null && result.distance !== undefined) ? `
                                    <span class="distance-badge">
                                        <span class="info-icon">â„¹
                                            <span class="info-tooltip">ÙØ§ØµÙ„Ù‡ Ø¨Ø±Ø¯Ø§Ø±: Ø¹Ø¯Ø¯ÛŒ Ø¨ÛŒÙ† Û° ØªØ§ Û² Ú©Ù‡ Ù†Ø´Ø§Ù†â€ŒØ¯Ù‡Ù†Ø¯Ù‡ ÙØ§ØµÙ„Ù‡ Ø¨Ø±Ø¯Ø§Ø± Ù†ØªÛŒØ¬Ù‡ Ø§Ø² Ø¨Ø±Ø¯Ø§Ø± Ú©ÙˆØ¦Ø±ÛŒ Ø§Ø³Øª. Ù‡Ø± Ú†Ù‡ Ø¹Ø¯Ø¯ Ú©Ù…ØªØ± Ø¨Ø§Ø´Ø¯ØŒ Ù†ØªÛŒØ¬Ù‡ Ù…Ø±ØªØ¨Ø·â€ŒØªØ± Ø§Ø³Øª.</span>
                                        </span>
                                        ÙØ§ØµÙ„Ù‡: ${Number(result.distance).toFixed(4)}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        ${renderDocumentWithContext(result.document, result.metadata, data.query || '')}
                        <div class="vote-buttons">
                            <button class="vote-button like" data-result-id="${encodeURIComponent(result.id)}" data-model-id="${resultModelId ?? ''}" onclick="voteOnResult(this, 'like')">ğŸ‘ Ù…ÙÛŒØ¯ Ø¨ÙˆØ¯</button>
                            <button class="vote-button dislike" data-result-id="${encodeURIComponent(result.id)}" data-model-id="${resultModelId ?? ''}" onclick="voteOnResult(this, 'dislike')">ğŸ‘ Ø¨ÛŒâ€ŒØ§Ø±ØªØ¨Ø§Ø·</button>
                            <span class="vote-feedback"></span>
                        </div>
                    </div>
                `;
            });
            
            // Add pagination controls at the bottom (before vote section)
            if (data.pagination) {
                html += generatePaginationHtml(data.pagination);
            }
            
            html += renderVoteSection(voteTargets);
            html += '</div>';
            resultsContainer.innerHTML = html;
        }

        function renderVoteSection(models) {
            if (!models || models.length === 0) {
                return '';
            }
            let html = '<div class="vote-section"><strong>Ù†Ø¸Ø± Ø´Ù…Ø§ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù†ØªØ§ÛŒØ¬</strong><p style="font-size:0.85rem; color:#666; margin:5px 0 10px;">Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ú©ÛŒÙÛŒØª Ø¬Ø³ØªØ¬ÙˆØŒ Ù„Ø·ÙØ§Ù‹ Ø±Ø¶Ø§ÛŒØª Ø®ÙˆØ¯ Ø§Ø² Ù‡Ø± Ù…Ø¯Ù„ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</p>';
            models.forEach(model => {
                const color = model.color || '#667eea';
                html += `
                    <div style="margin-bottom:12px;">
                        <span class="model-chip selected" style="background:${color}; color:#fff;">${escapeHtml(model.embedding_model || 'Ù†ØªØ§ÛŒØ¬')}</span>
                        <div class="vote-buttons">
                            <button class="vote-button like" data-model-id="${model.id ?? ''}" onclick="voteOnModel(this, 'like')">ğŸ‘ Ø±Ø¶Ø§ÛŒØª Ø¯Ø§Ø´ØªÙ…</button>
                            <button class="vote-button dislike" data-model-id="${model.id ?? ''}" onclick="voteOnModel(this, 'dislike')">ğŸ‘ Ø±Ø¶Ø§ÛŒØª Ù†Ø¯Ø§Ø´ØªÙ…</button>
                            <span class="vote-feedback"></span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        async function submitVoteRequest({ modelId, resultId = null, voteType }) {
            initGuestUser();
            const payload = {
                guest_user_id: guestUser.user_id,
                query: lastSearchContext.query,
                model_id: modelId,
                result_id: resultId,
                vote_type: voteType
            };
            const response = await fetch('/search/vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json; charset=utf-8',
                    'Accept': 'application/json; charset=utf-8'
                },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `HTTP ${response.status}`);
            }
            return response.json();
        }

        function updateVoteFeedback(container, stats) {
            if (!container) return;
            container.textContent = `ğŸ‘ ${stats.likes} | ğŸ‘ ${stats.dislikes}`;
        }

        window.voteOnResult = async function(buttonEl, voteType) {
            if (!lastSearchContext.query) {
                alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¬Ø³ØªØ¬Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.');
                return;
            }
            const resultId = buttonEl.dataset.resultId ? decodeURIComponent(buttonEl.dataset.resultId) : null;
            const modelIdAttr = buttonEl.dataset.modelId;
            const parsedModelId = modelIdAttr ? parseInt(modelIdAttr, 10) : null;
            const modelId = Number.isNaN(parsedModelId) ? null : parsedModelId;
            try {
                const stats = await submitVoteRequest({ modelId, resultId, voteType });
                const feedbackEl = buttonEl.parentElement.querySelector('.vote-feedback');
                updateVoteFeedback(feedbackEl, stats);
            } catch (error) {
                alert(`Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø±Ø§ÛŒ: ${error.message}`);
            }
        };

        window.voteOnModel = async function(buttonEl, voteType) {
            if (!lastSearchContext.query) {
                alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¬Ø³ØªØ¬Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.');
                return;
            }
            const modelIdAttr = buttonEl.dataset.modelId;
            const parsedModelId = modelIdAttr ? parseInt(modelIdAttr, 10) : null;
            const modelId = Number.isNaN(parsedModelId) ? null : parsedModelId;
            try {
                const stats = await submitVoteRequest({ modelId, voteType });
                const feedbackEl = buttonEl.parentElement.querySelector('.vote-feedback');
                updateVoteFeedback(feedbackEl, stats);
            } catch (error) {
                alert(`Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø±Ø§ÛŒ: ${error.message}`);
            }
        };

        async function loadHistory() {
            const historyContainer = document.getElementById('historyContainer');
            const recentContainer = document.getElementById('recentHistoryContainer');
            const topContainer = document.getElementById('topQueriesContainer');
            
            try {
                // Load recent searches
                const recentResponse = await fetch(`${API_BASE_URL}/history?limit=10`, {
                    headers: {
                        'Accept': 'application/json; charset=utf-8',
                    }
                });
                if (!recentResponse.ok) {
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡');
                }
                const recentData = await recentResponse.json();
                displayRecentHistory(recentData, recentContainer);
                
                // Load top queries
                try {
                    const topResponse = await fetch(`${API_BASE_URL}/history/top?limit=10&min_count=1`, {
                        headers: {
                            'Accept': 'application/json; charset=utf-8',
                        }
                    });
                    if (topResponse.ok) {
                        const topData = await topResponse.json();
                        displayTopQueries(topData, topContainer);
                    } else {
                        topContainer.innerHTML = '<p style="color: #666;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±Ø¨Ø³Ø§Ù…Ø¯ØªØ±ÛŒÙ† Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§</p>';
                    }
                } catch (topError) {
                    topContainer.innerHTML = '<p style="color: #666;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±Ø¨Ø³Ø§Ù…Ø¯ØªØ±ÛŒÙ† Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§</p>';
                }
            } catch (error) {
                historyContainer.innerHTML = `<div class="error">Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        function displayRecentHistory(data, container) {
            if (!data.searches || data.searches.length === 0) {
                container.innerHTML = '<p style="color: #666;">ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
                return;
            }

            // Deduplicate queries: group by query text and count occurrences
            const queryMap = new Map();
            data.searches.forEach(search => {
                const queryText = search.query.trim();
                if (queryMap.has(queryText)) {
                    const existing = queryMap.get(queryText);
                    existing.count += 1;
                    // Keep the most recent timestamp
                    if (new Date(search.timestamp) > new Date(existing.timestamp)) {
                        existing.timestamp = search.timestamp;
                        existing.result_count = search.result_count;
                        existing.took_ms = search.took_ms;
                    }
                } else {
                    queryMap.set(queryText, {
                        query: queryText,
                        count: 1,
                        timestamp: search.timestamp,
                        result_count: search.result_count,
                        took_ms: search.took_ms
                    });
                }
            });

            // Convert map to array and sort by timestamp (newest first)
            const uniqueSearches = Array.from(queryMap.values()).sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            let html = '<div style="display: grid; gap: 15px;">';
            uniqueSearches.forEach((search, index) => {
                const countDisplay = search.count > 1 ? ` <span style="color: #667eea; font-weight: bold;">(${search.count})</span>` : '';
                // Use data attribute to safely store query for click handler
                const queryEscaped = escapeHtml(search.query);
                html += `
                    <div class="result-item" style="padding: 15px; cursor: pointer; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa;" 
                         data-query="${queryEscaped.replace(/"/g, '&quot;')}" 
                         onclick="loadQueryFromHistory(this.dataset.query)">
                        <div style="margin-bottom: 10px;">
                            <strong>${queryEscaped}</strong>${countDisplay}
                            <span style="color: #666; font-size: 0.9rem; margin-right: 15px;">
                                ${new Date(search.timestamp).toLocaleString('fa-IR')}
                            </span>
                        </div>
                        <div style="color: #666; font-size: 0.9rem;">
                            Ù†ØªØ§ÛŒØ¬: ${search.result_count} | Ø²Ù…Ø§Ù†: ${search.took_ms.toFixed(2)}ms
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function displayTopQueries(data, container) {
            if (!data.queries || data.queries.length === 0) {
                container.innerHTML = '<p style="color: #666;">Ù¾Ø±Ø¨Ø³Ø§Ù…Ø¯ØªØ±ÛŒÙ† Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p>';
                return;
            }

            let html = '<div style="display: grid; gap: 15px;">';
            data.queries.forEach((query, index) => {
                const queryEscaped = escapeHtml(query.query);
                html += `
                    <div class="result-item" style="padding: 15px; cursor: pointer; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa;" 
                         data-query="${queryEscaped.replace(/"/g, '&quot;')}" 
                         onclick="loadQueryFromHistory(this.dataset.query)">
                        <div style="margin-bottom: 10px;">
                            <strong>${queryEscaped}</strong>
                            <span style="color: #667eea; font-weight: bold; margin-right: 10px;">(${query.search_count} Ø¨Ø§Ø±)</span>
                        </div>
                        <div style="color: #666; font-size: 0.9rem;">
                            Ø¢Ø®Ø±ÛŒÙ† Ø¬Ø³ØªØ¬Ùˆ: ${query.last_searched_at ? new Date(query.last_searched_at).toLocaleString('fa-IR') : '-'}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadQueryFromHistory(query) {
            // Set query in search input
            document.getElementById('query').value = query;
            // Set top_k to 20 (default)
            document.getElementById('topK').value = 20;
            // Focus on search input
            document.getElementById('query').focus();
            // Scroll to search box
            document.querySelector('.search-box').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        async function loadApprovedQueries() {
            const boxEl = document.getElementById('approvedQueriesBox');
            const listEl = document.getElementById('approvedQueriesList');

            try {
                const response = await fetch('/approved-queries', {
                    headers: {
                        'Accept': 'application/json; charset=utf-8'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.queries && data.queries.length > 0) {
                    let html = '';
                    data.queries.forEach(q => {
                        const queryEscaped = escapeHtml(q.query);
                        html += `
                            <div class="approved-query-chip" onclick="loadQueryFromHistory('${queryEscaped.replace(/'/g, "\\'")}')">
                                <span>${queryEscaped}</span>
                                <span class="approved-query-count">${q.search_count}</span>
                            </div>
                        `;
                    });
                    listEl.innerHTML = html;
                    boxEl.style.display = 'block';
                } else {
                    boxEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load approved queries:', error);
                boxEl.style.display = 'none';
            }
        }

        // Load approved queries on page load
        loadApprovedQueries();

        // Load version on page load
        async function loadVersion() {
            try {
                const response = await fetch('/version', {
                    headers: { 'Accept': 'application/json; charset=utf-8' }
                });
                if (response.ok) {
                    const data = await response.json();
                    const versionEl = document.getElementById('versionNumber');
                    const versionBottomEl = document.getElementById('versionNumberBottom');
                    if (versionEl) versionEl.textContent = data.version || '0.1.0';
                    if (versionBottomEl) versionBottomEl.textContent = data.version || '0.1.0';
                }
            } catch (error) {
                console.warn('Failed to load version:', error);
                const versionEl = document.getElementById('versionNumber');
                const versionBottomEl = document.getElementById('versionNumberBottom');
                if (versionEl) versionEl.textContent = '0.1.0';
                if (versionBottomEl) versionBottomEl.textContent = '0.1.0';
            }
        }

        // Load version when page loads
        loadVersion();

    </script>
    <footer style="text-align: center; padding: 20px; color: white; opacity: 0.8; font-size: 0.9rem; margin-top: 30px;">
        Ù†Ø³Ø®Ù‡: <span id="versionNumberBottom">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
    </footer>
</body>
</html>

