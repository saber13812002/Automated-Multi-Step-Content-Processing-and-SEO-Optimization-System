# راهنمای استفاده از `verify_chroma_export.py`

این اسکریپت برای اطمینان از موفقیت فرایند بارگذاری داده در ChromaDB طراحی شده است. با ارسال یک کوئری متنی، نزدیک‌ترین سگمنت‌ها را همراه با متادیتا و پیش‌نمایش متن چاپ می‌کند.

---

## نحوه اجرا

```bash
python verify_chroma_export.py \
  --collection book_pages_mini \
  --query "اعتقاد به آفریننده" \
  --host localhost \
  --port 8000 \
  --top-k 10
```

**پارامترهای مهم**
- `--collection`: نام کالکشنی که قبلاً توسط اسکریپت اکسپورت ایجاد شده است.
- `--query`: متن مورد جست‌وجو؛ می‌توانید آن را با عبارت دلخواه جایگزین کنید.
- `--top-k`: تعداد نتایج برتر که باید برگردد.
- `--host` و `--port`: آدرس سرویس ChromaDB.
- در صورت نیاز، کلید `--ssl`، `--api-key` یا `--persist-directory` را هم می‌توانید اضافه کنید.

---

## نمونه خروجی و تفسیر آن

```
Query: اعتقاد به آفریننده
Top 10 results from collection 'book_pages_mini':
--------------------------------------------------------------------------------
[1] ID: 1001-113-0-10-c6662ea8
Distance: 1.1791
Book: 'آموزش عقاید' (#1001)
Section: 'حیات ابدی و ایمان' (#1016), Page: 113, Paragraph: 0, Segment: 10
Link: https://mesbahyazdi.ir/node/1016#p113
Preview:  ... متن پاراگراف به صورت کوتاه ...
--------------------------------------------------------------------------------
```

- **ID**: شناسه یکتای سگمنت (کتاب، صفحه، پاراگراف، اندیس سگمنت و چند کاراکتر تصادفی).
- **Distance**: فاصله یا امتیاز شباهت؛ هرچه مقدار کمتر باشد، شباهت بیشتر است (تفسیر دقیق به مدل برداری بستگی دارد).
- **Book / Section / Page / Paragraph / Segment**: متادیتای رکورد؛ برای تعیین محل دقیق محتوا روی سایت/کتاب استفاده می‌شود.
- **Link**: همان `metadata.source_link` که در هنگام اکسپورت ذخیره شده است؛ وجود لینک مورد انتظار نشان می‌دهد رکورد به درستی منتقل شده است.
- **Preview**: ۲۰۰ کاراکتر اول متن سگمنت برای بررسی سریع محتوا. در صورت نیاز می‌توانید متن کامل را از کالکشن استخراج کنید.

> اگر در خروجی سگمنت مورد انتظار (مثلاً لینک `https://mesbahyazdi.ir/node/1003#p11`) ظاهر نشد، موارد زیر را بررسی کنید:
> - آیا فایل SQL ورودی آن رکورد را داشت؟
> - آیا پارامترهای `--collection` و `--query` به درستی تنظیم شده‌اند؟
> - آیا امبدینگ‌ها برای کالکشن تولید شده‌اند (اگر `--embedding-provider none` استفاده کردید، باید سمت سرور یا ابزار دیگری بردارها را بسازد)؟

---

## نکات تکمیلی
- اسکریپت در صورت نبود کالکشن پیامی مبنی بر اجرای اولیه‌ی صادرات نشان می‌دهد.
- برای کوئری‌های تکراری می‌توانید گزینه‌های `--collection`, `--query`, `--top-k` را در متغیرهای محیطی (`CHROMA_COLLECTION` و ...) تنظیم کنید.
- اگر خروجی حاوی کاراکترهای نامفهوم بود، ممکن است در داده‌ی اصلی HTML یا Encoding متفاوتی وجود داشته باشد؛ می‌توانید پارامترهای پاکسازی یا سگمنت‌بندی را در اسکریپت صادرات تنظیم کنید.

با استفاده از این راهنما می‌توانید خروجی اکسپورت را در چند دقیقه اعتبارسنجی کنید و از صحت متادیتا (به‌ویژه لینک‌های مرجع) مطمئن شوید.

